<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–ç•Œæ­´å²æ§‹é€ åŒ–ãƒªã‚¹ãƒˆ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        h1 { color: #004d40; border-bottom: 3px solid #b2dfdb; padding-bottom: 10px; margin-bottom: 30px; text-align: center; }
        /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #download-container { text-align: right; margin-bottom: 20px; }
        #download-btn { background-color: #ff9800; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; text-decoration: none; display: inline-block; }
        #download-btn:hover { background-color: #e68900; }
        
        /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .error-message {
            color: white;
            background-color: #d32f2f; /* èµ¤è‰² */
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-weight: bold;
        }

        /* ãƒªã‚¹ãƒˆè¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯å¤‰æ›´ãªã— */
        .region-card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 25px; padding: 20px; }
        .region-header { background-color: #4db6ac; color: white; padding: 10px 15px; border-radius: 6px 6px 0 0; margin: -20px -20px 20px -20px; font-size: 1.5em; font-weight: bold; }
        .period-section { margin-bottom: 20px; border-left: 4px solid #009688; padding-left: 15px; }
        .period-upper { font-size: 1.2em; color: #00796b; margin-bottom: 10px; font-weight: bold; }
        .middle-entities-list { list-style-type: disc; margin-left: 20px; padding-left: 0; line-height: 1.6; display: flex; flex-wrap: wrap; }
        .middle-entities-list li { margin-right: 15px; margin-bottom: 5px; background-color: #e0f2f1; padding: 4px 8px; border-radius: 3px; }
    </style>
</head>
<body>

    <h1>ä¸–ç•Œæ­´å²æ§‹é€ åŒ–ãƒªã‚¹ãƒˆ</h1>
    <div id="download-container"></div>
    <div id="history-list-container">
        <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <script>
        const container = document.getElementById('history-list-container');
        const downloadContainer = document.getElementById('download-container');
        const totalFiles = 9;
        const fileBaseName = 'no';
        const fileExtension = '.json';
        const basePath = './';

        /**
         * è¤‡æ•°ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †ç•ªã«èª­ã¿è¾¼ã¿ã€çµ±åˆã™ã‚‹é–¢æ•°
         */
        async function loadAndIntegrateJson() {
            let integratedRegions = [];

            try {
                for (let i = 1; i <= totalFiles; i++) {
                    const fileName = `${fileBaseName}${i}${fileExtension}`;
                    const url = basePath + fileName;

                    // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€èª­ã¿è¾¼ã¿ä¸­ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (Status: ${response.status})`);
                    }

                    const text = await response.text();
                    
                    // 2. JSONè§£æ (ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ ¸ã¨ãªã‚‹éƒ¨åˆ†)
                    let jsonContent;
                    try {
                        jsonContent = JSON.parse(text);
                    } catch (e) {
                        // JSON.parseãŒå¤±æ•—ã—ãŸå ´åˆã€ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›
                        throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileName}ã€ã§JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°: ${e.message}`);
                    }
                    
                    // 3. ãƒ‡ãƒ¼ã‚¿ã®çµ±åˆ
                    if (jsonContent && jsonContent.history_structured_list && jsonContent.history_structured_list.regions) {
                        integratedRegions.push(...jsonContent.history_structured_list.regions);
                    } else {
                         throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileName}ã€ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒæœŸå¾…ã•ã‚ŒãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
                    }
                }

                // ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«çµ±åˆã•ã‚ŒãŸå¾Œã®æœ€çµ‚ãƒ‡ãƒ¼ã‚¿
                const finalIntegratedData = { history_structured_list: { regions: integratedRegions } };
                displayData(finalIntegratedData); // æˆåŠŸæ™‚ã®è¡¨ç¤ºã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ç”Ÿæˆ

            } catch (error) {
                // èª­ã¿è¾¼ã¿ã€è§£æã€ã¾ãŸã¯æ§‹é€ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
                container.innerHTML = `<div class="error-message">ğŸš¨ çµ±åˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ ğŸš¨<br><strong>ã‚¨ãƒ©ãƒ¼å†…å®¹:</strong> ${error.message}</div>`;
                downloadContainer.innerHTML = ''; // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã¯è¡¨ç¤ºã—ãªã„
                console.error("çµ±åˆå‡¦ç†ã®è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’HTMLã«å‡ºåŠ›ã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
        function displayData(integratedData) {
            container.innerHTML = ''; 
            const regions = integratedData.history_structured_list.regions;

            // --- 1. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ç”Ÿæˆ ---
            const jsonString = JSON.stringify(integratedData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const downloadLink = document.createElement('a');
            downloadLink.id = 'download-btn';
            downloadLink.href = url;
            downloadLink.download = 'integrated_world_history.json'; 
            downloadLink.textContent = 'ğŸ“¥ çµ±åˆJSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            
            downloadContainer.innerHTML = '';
            downloadContainer.appendChild(downloadLink);

            // --- 2. ãƒªã‚¹ãƒˆè¡¨ç¤º ---
            regions.forEach(region => {
                const regionCard = document.createElement('div');
                regionCard.className = 'region-card';

                const regionHeader = document.createElement('div');
                regionHeader.className = 'region-header';
                regionHeader.textContent = `åœ°åŸŸ ${region.region_id}: ${region.region_name}`;
                regionCard.appendChild(regionHeader);

                region.periods.forEach(period => {
                    const periodSection = document.createElement('div');
                    periodSection.className = 'period-section';

                    const upperLevel = document.createElement('div');
                    upperLevel.className = 'period-upper';
                    upperLevel.textContent = period.upper_level;
                    periodSection.appendChild(upperLevel);

                    const entitiesList = document.createElement('ul');
                    entitiesList.className = 'middle-entities-list';

                    period.middle_level_entities.forEach(entity => {
                        const listItem = document.createElement('li');
                        listItem.textContent = entity;
                        entitiesList.appendChild(listItem);
                    });

                    periodSection.appendChild(entitiesList);
                    regionCard.appendChild(periodSection);
                });

                container.appendChild(regionCard);
            });
        }

        // å‡¦ç†ã‚’é–‹å§‹
        loadAndIntegrateJson();
    </script>

</body>
</html>
